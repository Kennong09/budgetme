import{s as a}from"./index-BbApZ7g3.js";class d{static async fetchUserAccounts(t){try{const{data:e,error:r}=await a.from("accounts").select("*").eq("user_id",t).eq("status","active").order("is_default",{ascending:!1}).order("account_name",{ascending:!0});return r?(console.error("Error fetching accounts:",r),{success:!1,error:r.message}):{success:!0,data:e||[]}}catch(e){return console.error("Exception fetching accounts:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}static async createAccount(t){try{if(!t.account_name?.trim())return{success:!1,error:"Account name is required"};if(isNaN(t.balance))return{success:!1,error:"Please enter a valid balance amount"};if(t.account_type==="credit"&&t.balance>0)return{success:!1,error:"Credit account balance must be zero or negative"};t.is_default&&await this.unsetOtherDefaults(t.user_id);const{data:e,error:r}=await a.from("accounts").insert({...t,initial_balance:t.balance,currency:"PHP",created_at:new Date().toISOString()}).select().single();return r?(console.error("Error creating account:",r),{success:!1,error:r.message}):{success:!0,data:e}}catch(e){return console.error("Exception creating account:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}static async updateAccount(t,e,r){try{if(e.account_name!==void 0&&!e.account_name?.trim())return{success:!1,error:"Account name is required"};if(e.balance!==void 0&&isNaN(e.balance))return{success:!1,error:"Please enter a valid balance amount"};if(e.account_type==="credit"&&e.balance!==void 0&&e.balance>0)return{success:!1,error:"Credit account balance must be zero or negative"};e.is_default&&await this.unsetOtherDefaults(r,t);const{data:s,error:c}=await a.from("accounts").update({...e,currency:"PHP",updated_at:new Date().toISOString()}).eq("id",t).eq("user_id",r).select().single();return c?(console.error("Error updating account:",c),{success:!1,error:c.message}):{success:!0,data:s}}catch(s){return console.error("Exception updating account:",s),{success:!1,error:s instanceof Error?s.message:"Unknown error"}}}static async deleteAccount(t,e){try{const{data:r,error:s}=await a.from("accounts").select("id, is_default").eq("user_id",e).eq("status","active");if(s)return{success:!1,error:s.message};if(!r||r.length<=1)return{success:!1,error:"You must have at least one active account"};const c=r.find(o=>o.id===t);if(!c)return{success:!1,error:"Account not found"};const{error:n}=await a.from("accounts").update({status:"inactive",updated_at:new Date().toISOString()}).eq("id",t).eq("user_id",e);if(n)return{success:!1,error:n.message};let i;if(c.is_default){const o=r.filter(u=>u.id!==t);if(o.length>0){i=o[0].id;const{error:u}=await a.from("accounts").update({is_default:!0,updated_at:new Date().toISOString()}).eq("id",i).eq("user_id",e);u&&console.warn("Failed to set new default account:",u)}}return{success:!0,newDefaultAccountId:i}}catch(r){return console.error("Exception deleting account:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}static async validateAccountOwnership(t,e){try{const{data:r,error:s}=await a.from("accounts").select("id").eq("id",t).eq("user_id",e).single();return s?(console.error("Error validating account ownership:",s),!1):!!r}catch(r){return console.error("Exception validating account ownership:",r),!1}}static async getAccountSummary(t,e){try{const{data:r,error:s}=await a.from("accounts").select("balance").eq("id",t).eq("user_id",e).single();if(s)return{success:!1,error:s.message};const{data:c,error:n}=await a.from("transactions").select("date").eq("account_id",t).eq("user_id",e).order("date",{ascending:!1});return n?{success:!0,data:{balance:r.balance,transactionCount:0}}:{success:!0,data:{balance:r.balance,transactionCount:c?.length||0,lastTransactionDate:c?.[0]?.date}}}catch(r){return console.error("Exception getting account summary:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}static async unsetOtherDefaults(t,e){try{let r=a.from("accounts").update({is_default:!1,updated_at:new Date().toISOString()}).eq("user_id",t).eq("is_default",!0);e&&(r=r.neq("id",e));const{error:s}=await r;s&&console.warn("Failed to unset other default accounts:",s)}catch(r){console.warn("Exception unsetting other default accounts:",r)}}static async setDefaultAccount(t,e){try{const{data:r,error:s}=await a.from("accounts").select("*").eq("id",t).eq("user_id",e).eq("status","active").single();if(s)return{success:!1,error:"Account not found or access denied"};if(!r)return{success:!1,error:"Account is inactive and cannot be set as default"};if(r.is_default)return{success:!0,data:r};await this.unsetOtherDefaults(e,t);const{data:c,error:n}=await a.from("accounts").update({is_default:!0,updated_at:new Date().toISOString()}).eq("id",t).eq("user_id",e).select().single();return n?{success:!1,error:n.message}:{success:!0,data:c}}catch(r){return console.error("Exception setting default account:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error"}}}static async getDefaultAccount(t){try{const{data:e,error:r}=await a.from("accounts").select("*").eq("user_id",t).eq("status","active").eq("is_default",!0).single();return r&&r.code!=="PGRST116"?{success:!1,error:r.message}:{success:!0,data:e||null}}catch(e){return console.error("Exception getting default account:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}static async ensureDefaultAccount(t){try{const e=await this.getDefaultAccount(t);if(!e.success)return{success:!1,error:e.error};if(e.data)return{success:!0,data:e.data};const{data:r,error:s}=await a.from("accounts").select("*").eq("user_id",t).eq("status","active").order("created_at",{ascending:!0}).limit(1).single();return s?{success:!1,error:"No active accounts found to set as default"}:r?await this.setDefaultAccount(r.id,t):{success:!1,error:"No accounts available to set as default"}}catch(e){return console.error("Exception ensuring default account:",e),{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}static async ensureDefaultAccountLegacy(t){return(await this.ensureDefaultAccount(t)).success}}export{d as A};
