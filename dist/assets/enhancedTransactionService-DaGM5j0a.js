import{s as c}from"./index-BbApZ7g3.js";import{T as d}from"./transactionService-B7dXImam.js";class l extends d{static async fetchTransactionForEdit(a,e){try{const{data:r,error:t}=await c.from("transactions").select("*").eq("id",a).eq("user_id",e).single();return t?{success:!1,error:t.message}:r?{success:!0,data:this.mapDatabaseToComponent(r)}:{success:!1,error:"Transaction not found or access denied"}}catch(r){return console.error("Enhanced Transaction Service: Error fetching transaction:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}}static async updateTransactionWithMapping(a,e,r){try{const t=await this.validateCategoryMatch(r.category_id,r.type,e);if(!t.valid)return{success:!1,error:t.error||"Invalid category selection"};const o=this.mapComponentToDatabase(r),{data:s,error:n}=await c.from("transactions").update(o).eq("id",a).eq("user_id",e).select().single();return n?{success:!1,error:n.message}:{success:!0,data:this.mapDatabaseToComponent(s)}}catch(t){return console.error("Enhanced Transaction Service: Error updating transaction:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error occurred"}}}static async createTransactionWithMapping(a,e){try{const r=await this.validateCategoryMatch(e.category_id,e.type,a);if(!r.valid)return{success:!1,error:r.error||"Invalid category selection"};const t={...this.mapComponentToDatabase(e),user_id:a},{data:o,error:s}=await c.from("transactions").insert(t).select().single();return s?{success:!1,error:s.message}:{success:!0,data:this.mapDatabaseToComponent(o)}}catch(r){return console.error("Enhanced Transaction Service: Error creating transaction:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}}static mapDatabaseToComponent(a){const e={...a};return a.type==="income"&&a.income_category_id?e.category_id=a.income_category_id:(a.type==="expense"||a.type==="contribution")&&a.expense_category_id?e.category_id=a.expense_category_id:e.category_id=a.category_id||"",e}static mapComponentToDatabase(a){const e={...a};return"category_id"in e&&delete e.category_id,a.type==="income"?(e.income_category_id=a.category_id,e.expense_category_id=null):(a.type==="expense"||a.type==="contribution")&&(e.expense_category_id=a.category_id,e.income_category_id=null),e}static async validateCategoryMatch(a,e,r){if(!a)return{valid:!1,error:"Category is required"};try{if(e==="income"){const{data:t,error:o}=await c.from("income_categories").select("id").eq("id",a).eq("user_id",r).single();if(o||!t)return{valid:!1,error:"Selected category is not a valid income category"}}else if(e==="expense"||e==="contribution"){const{data:t,error:o}=await c.from("expense_categories").select("id").eq("id",a).eq("user_id",r).single();if(o||!t)return{valid:!1,error:"Selected category is not a valid expense category"}}return{valid:!0}}catch(t){return console.error("Enhanced Transaction Service: Error validating category:",t),{valid:!1,error:"Error validating category selection"}}}static async fetchTransactionsWithMapping(a,e){try{let r=c.from("transactions").select("*",{count:"exact"}).eq("user_id",a).order("date",{ascending:!1});e?.type&&e.type!=="all"&&(r=r.eq("type",e.type)),e?.account_id&&(r=r.eq("account_id",e.account_id)),e?.category_id&&(r=r.or(`income_category_id.eq.${e.category_id},expense_category_id.eq.${e.category_id}`)),e?.start_date&&(r=r.gte("date",e.start_date)),e?.end_date&&(r=r.lte("date",e.end_date)),e?.limit&&(r=r.limit(e.limit)),e?.offset&&(r=r.range(e.offset,e.offset+(e.limit||50)-1));const{data:t,error:o,count:s}=await r;return o?{success:!1,error:o.message}:{success:!0,data:t?.map(i=>this.mapDatabaseToComponent(i))||[],count:s||0}}catch(r){return console.error("Enhanced Transaction Service: Error fetching transactions:",r),{success:!1,error:r instanceof Error?r.message:"Unknown error occurred"}}}}export{l as E};
