var m=Object.defineProperty;var p=(l,r,e)=>r in l?m(l,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[r]=e;var g=(l,r,e)=>p(l,typeof r!="symbol"?r+"":r,e);import{s as i}from"./index-BbApZ7g3.js";const _=[{account_name:"Primary Checking",account_type:"checking",initial_balance:0,status:"active",is_default:!0,description:"Main checking account for daily transactions",color:"#4e73df"},{account_name:"Savings Account",account_type:"savings",initial_balance:0,status:"active",is_default:!1,description:"Primary savings account",color:"#1cc88a"},{account_name:"Credit Card",account_type:"credit",initial_balance:0,status:"active",is_default:!1,description:"Primary credit card account",color:"#e74a3b"}],d=[{category_name:"Salary",icon:"cash",color:"#4CAF50",is_default:!0,is_active:!0,description:"Monthly salary income"},{category_name:"Freelance",icon:"briefcase",color:"#4CAF50",is_default:!0,is_active:!0,description:"Freelance and contract work"},{category_name:"Investments",icon:"trending-up",color:"#4CAF50",is_default:!0,is_active:!0,description:"Investment returns and dividends"},{category_name:"Gifts",icon:"gift",color:"#4CAF50",is_default:!0,is_active:!0,description:"Money gifts and windfalls"},{category_name:"Other Income",icon:"plus-circle",color:"#4CAF50",is_default:!0,is_active:!0,description:"Miscellaneous income sources"}],f=[{category_name:"Housing",icon:"home",color:"#F44336",is_default:!0,is_active:!0,description:"Rent, mortgage, and housing expenses"},{category_name:"Utilities",icon:"zap",color:"#F44336",is_default:!0,is_active:!0,description:"Electricity, water, gas, internet"},{category_name:"Groceries",icon:"shopping-cart",color:"#F44336",is_default:!0,is_active:!0,description:"Food and grocery shopping"},{category_name:"Transportation",icon:"truck",color:"#F44336",is_default:!0,is_active:!0,description:"Gas, public transport, vehicle maintenance"},{category_name:"Dining Out",icon:"coffee",color:"#F44336",is_default:!0,is_active:!0,description:"Restaurants and food delivery"},{category_name:"Entertainment",icon:"film",color:"#F44336",is_default:!0,is_active:!0,description:"Movies, games, hobbies"},{category_name:"Healthcare",icon:"activity",color:"#F44336",is_default:!0,is_active:!0,description:"Medical expenses and insurance"},{category_name:"Education",icon:"book",color:"#F44336",is_default:!0,is_active:!0,description:"Learning and educational expenses"},{category_name:"Shopping",icon:"shopping-bag",color:"#F44336",is_default:!0,is_active:!0,description:"Clothing and general shopping"},{category_name:"Personal Care",icon:"user",color:"#F44336",is_default:!0,is_active:!0,description:"Haircuts, personal grooming"},{category_name:"Travel",icon:"map",color:"#F44336",is_default:!0,is_active:!0,description:"Travel and vacation expenses"},{category_name:"Subscriptions",icon:"repeat",color:"#F44336",is_default:!0,is_active:!0,description:"Monthly subscriptions and services"},{category_name:"Contribution",icon:"piggy-bank",color:"#F44336",is_default:!0,is_active:!0,description:"Goal contributions and savings"},{category_name:"Other Expenses",icon:"more-horizontal",color:"#F44336",is_default:!0,is_active:!0,description:"Miscellaneous expenses"}];class u{static async initializeUserDefaults(r){const e={success:!1,accounts_created:0,income_categories_created:0,expense_categories_created:0,errors:[]};try{const s=await this.validateUserHasDefaults(r);if(s.missing_defaults.length===0)return e.success=!0,e.errors?.push("User already has complete default configurations"),e;if(console.log(`Creating missing defaults for user ${r}: ${s.missing_defaults.join(", ")}`),s.missing_defaults.includes("accounts")){const o=await this.createDefaultAccounts(r);e.accounts_created=o.length}if(s.missing_defaults.includes("income_categories")){const o=await this.createDefaultIncomeCategories(r);e.income_categories_created=o.length}if(s.missing_defaults.includes("expense_categories")){const o=await this.createDefaultExpenseCategories(r);e.expense_categories_created=o.length}return e.success=!0,e}catch(s){const o=s instanceof Error?s.message:"Unknown error occurred";return e.errors?.push(`Initialization failed: ${o}`),e}}static async createDefaultAccounts(r){const{data:e,error:s}=await i.from("accounts").select("account_type").eq("user_id",r);s&&console.error("Error checking existing accounts:",s);const o=e?.map(t=>t.account_type)||[];console.log(`User ${r} existing account types:`,o);const a=_.filter(t=>!o.includes(t.account_type)).map(t=>({user_id:r,account_name:t.account_name,account_type:t.account_type,balance:t.initial_balance,initial_balance:t.initial_balance,currency:"PHP",status:t.status,is_default:t.is_default,description:t.description,color:t.color||"#4e73df"}));if(a.length===0)return console.log(`No new accounts to create for user ${r} - all types already exist`),[];console.log(`Creating ${a.length} accounts for user ${r}:`,a.map(t=>`${t.account_type} (${t.account_name})`));const{data:c,error:n}=await i.from("accounts").insert(a).select();if(n)throw new Error(`Failed to create accounts: ${n.message}`);return console.log(`Successfully created ${c?.length||0} accounts for user ${r}`),c||[]}static async createDefaultIncomeCategories(r){const{data:e,error:s}=await i.from("income_categories").select("category_name").eq("user_id",r);s&&console.error("Error checking existing income categories:",s);const o=e?.map(t=>t.category_name)||[],a=d.filter(t=>!o.includes(t.category_name)).map(t=>({user_id:r,category_name:t.category_name,icon:t.icon,color:t.color,is_default:t.is_default,is_active:t.is_active,description:t.description}));if(a.length===0)return console.log(`No new income categories to create for user ${r}`),[];const{data:c,error:n}=await i.from("income_categories").insert(a).select();if(n)throw new Error(`Failed to create income categories: ${n.message}`);return c||[]}static async createDefaultExpenseCategories(r){const{data:e,error:s}=await i.from("expense_categories").select("category_name").eq("user_id",r);s&&console.error("Error checking existing expense categories:",s);const o=e?.map(t=>t.category_name)||[],a=f.filter(t=>!o.includes(t.category_name)).map(t=>({user_id:r,category_name:t.category_name,icon:t.icon,color:t.color,is_default:t.is_default,is_active:t.is_active,description:t.description,monthly_budget:t.monthly_budget}));if(a.length===0)return console.log(`No new expense categories to create for user ${r}`),[];const{data:c,error:n}=await i.from("expense_categories").insert(a).select();if(n)throw new Error(`Failed to create expense categories: ${n.message}`);return c||[]}static getAccountTemplate(){return[..._]}static getIncomeCategoryTemplate(){return[...d]}static getExpenseCategoryTemplate(){return[...f]}static async validateUserHasDefaults(r){const e={has_accounts:!1,has_income_categories:!1,has_expense_categories:!1,missing_defaults:[]};try{const{data:s,error:o}=await i.from("accounts").select("id").eq("user_id",r).limit(1);o?console.error("Error checking accounts:",o):e.has_accounts=s&&s.length>0;const{data:a,error:c}=await i.from("income_categories").select("id").eq("user_id",r).limit(1);c?console.error("Error checking income categories:",c):e.has_income_categories=a&&a.length>0;const{data:n,error:t}=await i.from("expense_categories").select("id").eq("user_id",r).limit(1);t?console.error("Error checking expense categories:",t):e.has_expense_categories=n&&n.length>0,e.has_accounts||e.missing_defaults.push("accounts"),e.has_income_categories||e.missing_defaults.push("income_categories"),e.has_expense_categories||e.missing_defaults.push("expense_categories")}catch(s){console.error("Error in validateUserHasDefaults:",s),e.missing_defaults=["accounts","income_categories","expense_categories"]}return e}static async resetUserDefaults(r){const e={success:!1,accounts_removed:0,income_categories_removed:0,expense_categories_removed:0,errors:[]};try{const{data:s,error:o}=await i.from("accounts").delete().eq("user_id",r).eq("is_default",!0).select("id");o?e.errors?.push(`Error removing accounts: ${o.message}`):e.accounts_removed=s?.length||0;const{data:a,error:c}=await i.from("income_categories").delete().eq("user_id",r).eq("is_default",!0).select("id");c?e.errors?.push(`Error removing income categories: ${c.message}`):e.income_categories_removed=a?.length||0;const{data:n,error:t}=await i.from("expense_categories").delete().eq("user_id",r).eq("is_default",!0).select("id");return t?e.errors?.push(`Error removing expense categories: ${t.message}`):e.expense_categories_removed=n?.length||0,e.success=(e.errors?.length||0)===0,e}catch(s){const o=s instanceof Error?s.message:"Unknown error occurred";return e.errors?.push(`Reset failed: ${o}`),e}}static async migrateExistingUser(r){const e={success:!1,users_processed:0,accounts_created:0,income_categories_created:0,expense_categories_created:0,errors:[]};try{const{data:s,error:o}=await i.from("auth.users").select("id").eq("id",r).single();if(o||!s)return e.errors?.push(`User not found: ${r}`),e;if((await this.validateUserHasDefaults(r)).missing_defaults.length===0)return e.success=!0,e.users_processed=1,e;const c=await this.initializeUserDefaults(r);return e.success=c.success,e.users_processed=c.success?1:0,e.accounts_created=c.accounts_created,e.income_categories_created=c.income_categories_created,e.expense_categories_created=c.expense_categories_created,c.errors&&e.errors?.push(...c.errors),e}catch(s){const o=s instanceof Error?s.message:"Unknown error occurred";return e.errors?.push(`Migration failed for user ${r}: ${o}`),e}}static async bulkMigrateUsers(r){const e={success:!1,users_processed:0,accounts_created:0,income_categories_created:0,expense_categories_created:0,errors:[]};for(const s of r)try{const o=await this.migrateExistingUser(s);e.users_processed+=o.users_processed,e.accounts_created+=o.accounts_created,e.income_categories_created+=o.income_categories_created,e.expense_categories_created+=o.expense_categories_created,o.errors&&e.errors?.push(...o.errors)}catch(o){const a=o instanceof Error?o.message:"Unknown error occurred";e.errors?.push(`Bulk migration error for user ${s}: ${a}`)}return e.success=e.users_processed>0&&(e.errors?.length||0)===0,e}static async getUserDefaultAccounts(r){const{data:e,error:s}=await i.from("accounts").select("*").eq("user_id",r).eq("is_default",!0).order("created_at",{ascending:!0});return s?(console.error("Error fetching user default accounts:",s),[]):e||[]}static async getUserDefaultIncomeCategories(r){const{data:e,error:s}=await i.from("income_categories").select("*").eq("user_id",r).eq("is_default",!0).order("created_at",{ascending:!0});return s?(console.error("Error fetching user default income categories:",s),[]):e||[]}static async getUserDefaultExpenseCategories(r){const{data:e,error:s}=await i.from("expense_categories").select("*").eq("user_id",r).eq("is_default",!0).order("created_at",{ascending:!0});return s?(console.error("Error fetching user default expense categories:",s),[]):e||[]}}class h{static async completeUserOnboarding(r){try{console.log(`Starting onboarding for user: ${r}`);const e=await u.validateUserHasDefaults(r);if(e.missing_defaults.length===0)return console.log(`User ${r} already has complete setup`),{success:!0,details:{message:"User already has complete setup",existing_setup:!0}};console.log(`User ${r} missing defaults: ${e.missing_defaults.join(", ")}`);const s=await u.initializeUserDefaults(r);return s.success?(console.log(`Successfully initialized defaults for user ${r}`),console.log(`- Accounts created: ${s.accounts_created}`),console.log(`- Income categories created: ${s.income_categories_created}`),console.log(`- Expense categories created: ${s.expense_categories_created}`),{success:!0,details:{message:"User onboarding completed successfully",accounts_created:s.accounts_created,income_categories_created:s.income_categories_created,expense_categories_created:s.expense_categories_created}}):(console.error(`Failed to initialize defaults for user ${r}:`,s.errors),{success:!1,error:`Failed to initialize user defaults: ${s.errors?.join(", ")}`,details:s})}catch(e){return console.error(`Error during user onboarding for ${r}:`,e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred",details:{originalError:e}}}}static async checkOnboardingStatus(r){try{const e=await u.validateUserHasDefaults(r);return{isComplete:e.missing_defaults.length===0,missingDefaults:e.missing_defaults,details:{has_accounts:e.has_accounts,has_income_categories:e.has_income_categories,has_expense_categories:e.has_expense_categories}}}catch(e){return console.error(`Error checking onboarding status for ${r}:`,e),{isComplete:!1,missingDefaults:["unknown"],details:{error:e instanceof Error?e.message:"Unknown error"}}}}static async getUserDefaultAccounts(r){try{return await u.getUserDefaultAccounts(r)}catch(e){return console.error(`Error fetching user default accounts for ${r}:`,e),[]}}static async getUserDefaultIncomeCategories(r){try{return await u.getUserDefaultIncomeCategories(r)}catch(e){return console.error(`Error fetching user default income categories for ${r}:`,e),[]}}static async getUserDefaultExpenseCategories(r){try{return await u.getUserDefaultExpenseCategories(r)}catch(e){return console.error(`Error fetching user default expense categories for ${r}:`,e),[]}}static async resetUserDefaults(r){try{console.log(`Resetting defaults for user: ${r}`);const e=await u.resetUserDefaults(r);return e.success?(console.log(`Successfully reset defaults for user ${r}`),console.log(`- Accounts removed: ${e.accounts_removed}`),console.log(`- Income categories removed: ${e.income_categories_removed}`),console.log(`- Expense categories removed: ${e.expense_categories_removed}`),{success:!0,details:{message:"User defaults reset successfully",accounts_removed:e.accounts_removed,income_categories_removed:e.income_categories_removed,expense_categories_removed:e.expense_categories_removed}}):(console.error(`Failed to reset defaults for user ${r}:`,e.errors),{success:!1,error:`Failed to reset user defaults: ${e.errors?.join(", ")}`,details:e})}catch(e){return console.error(`Error resetting user defaults for ${r}:`,e),{success:!1,error:e instanceof Error?e.message:"Unknown error occurred",details:{originalError:e}}}}static async handleNewUserRegistration(r,e){try{console.log(`Handling new user registration: ${r} (${e||"no email"})`),await new Promise(o=>setTimeout(o,1e3));const s=await this.completeUserOnboarding(r);s.success?console.log(`New user ${r} onboarding completed successfully`):console.error(`Onboarding failed for new user ${r}:`,s.error)}catch(s){console.error(`Error handling new user registration for ${r}:`,s)}}static async ensureUserSetup(r){try{const e=`onboarding_${r}`,s=Date.now();if(this.onboardingCache.has(e)){const a=this.onboardingCache.get(e);if(s-a.timestamp<3e4)return console.log(`Skipping ensureUserSetup for ${r} - recently processed`),a.result}if(console.log(`Ensuring user setup for ${r}...`),!(await this.checkOnboardingStatus(r)).isComplete){console.log(`User ${r} setup incomplete, running onboarding...`);const a=await this.completeUserOnboarding(r);return this.onboardingCache.set(e,{timestamp:s,result:a.success}),a.success}return this.onboardingCache.set(e,{timestamp:s,result:!0}),!0}catch(e){return console.error(`Error ensuring user setup for ${r}:`,e),!1}}static async getOnboardingProgress(r){try{const e=await u.validateUserHasDefaults(r),s={accounts:e.has_accounts,income_categories:e.has_income_categories,expense_categories:e.has_expense_categories},o=Object.values(s).filter(Boolean).length,a=Object.keys(s).length,c=Math.round(o/a*100);return{completed:e.missing_defaults.length===0,progress:c,steps:s}}catch(e){return console.error(`Error getting onboarding progress for ${r}:`,e),{completed:!1,progress:0,steps:{accounts:!1,income_categories:!1,expense_categories:!1}}}}}g(h,"onboardingCache",new Map);export{h as U};
