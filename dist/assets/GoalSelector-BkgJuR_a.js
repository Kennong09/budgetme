import{j as e}from"./ui-vendor-Cn1Vfl4w.js";import{r as l}from"./react-vendor-D4A9EtXC.js";import{u as H,b as q,h as J,s as A}from"./index-BbApZ7g3.js";import{b as K,P as Q}from"./PermissionErrorModal-Dc2W8uaB.js";const ee=({selectedGoal:i=null,onGoalSelect:S,className:L="",disabled:_=!1,label:D="Goal Assignment (Optional)",required:c=!1,isContributionType:m=!1,showValidationError:y=!1,onGoalsLoaded:R,validateFamilyGoalAccess:o=!1})=>{const{user:d}=H(),{showErrorToast:M}=q(),r=K(),[k,j]=l.useState([]),[g,b]=l.useState(!1),[U,P]=l.useState(null),[h,N]=l.useState(!1),[v,w]=l.useState(""),[f,C]=l.useState({isOpen:!1,title:"",message:""}),E=k.filter(a=>a.goal_name.toLowerCase().includes(v.toLowerCase())),T=async a=>{if(o&&a.is_family_goal){const t=await r.checkCanAccessGoal(a.id);if(!t.hasPermission){C({isOpen:!0,title:"Access Denied",message:t.errorMessage||"You do not have permission to access this family goal.",suggestedActions:t.restrictions||["Contact your family admin for assistance"],userRole:t.userRole});return}if(m){const n=await r.checkCanContributeToGoals();if(!n.hasPermission){C({isOpen:!0,title:"Contribution Access Denied",message:n.errorMessage||"You do not have permission to contribute to family goals.",suggestedActions:n.restrictions||["Contact your family admin for assistance"],userRole:n.userRole});return}}}S(a),N(!1),w("")},z=()=>{S(null),N(!1),w("")};return l.useEffect(()=>{(async()=>{if(!d){j([]);return}b(!0),P(null);try{const{data:t,error:n}=await J.fetchGoals(d.id);if(n)throw n;if(!t){console.warn("No personal goals data received"),j([]),b(!1);return}const F=t.map(s=>({...s,is_family_goal:!!s.family_id||!!s.is_family_goal,percentage:s.percentage||(s.target_amount>0?s.current_amount/s.target_amount*100:0),remaining:s.remaining||Math.max(0,s.target_amount-s.current_amount)}));let u=F;o&&!r.loading&&(u=F.filter(s=>s.is_family_goal?r.hasBasicAccess:!0));let $=[...u];const{data:G,error:I}=await A.from("family_members").select("family_id").eq("user_id",d.id).single();if(!I&&G?.family_id){const{data:s,error:Y}=await A.from("goals").select(`
              *,
              profiles!user_id (
                full_name,
                email
              )
            `).eq("family_id",G.family_id).eq("is_family_goal",!0).in("status",["not_started","in_progress"]).neq("user_id",d.id);if(!Y&&s){const B=s.map(p=>({...p,is_family_goal:!0,shared_by:p.user_id,shared_by_name:p.profiles?.full_name||p.profiles?.email?.split("@")[0]||"Family Member"}));$=[...u,...B]}}const x=$.filter(s=>s.status==="completed"||s.status==="cancelled"||s.current_amount>=s.target_amount?!1:s.status==="not_started"||s.status==="in_progress").map(s=>({id:s.id,goal_name:s.goal_name,target_amount:s.target_amount,current_amount:s.current_amount,target_date:s.target_date,priority:s.priority,status:s.status,is_family_goal:s.is_family_goal||!1}));console.log(`GoalSelector: Retrieved ${x.length} active goals (${u.filter(s=>s.status==="not_started"||s.status==="in_progress").length} personal, ${x.length-u.filter(s=>s.status==="not_started"||s.status==="in_progress").length} shared)`);let O=x;m&&o&&!r.loading&&(O=x.filter(s=>s.is_family_goal?r.hasContributionAccess:!0)),j(O),R&&R(x.length>0)}catch(t){const n=t instanceof Error?t.message:"Failed to load goals";console.error("GoalSelector: Error loading goals:",t),P(n),M(n)}finally{b(!1)}})()},[d?.id,M,o,r.loading,r.hasBasicAccess,r.hasContributionAccess,m]),e.jsxs("div",{className:`form-group selector-container ${L}`,children:[e.jsxs("label",{className:"font-weight-bold text-gray-800",children:[D," ",c&&e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("div",{className:"position-relative",children:[e.jsxs("div",{className:`d-flex align-items-center justify-content-between px-3 py-2 border bg-white ${_||g?"bg-light":""} ${h?"border-primary":"border-secondary"} ${y&&c&&!i?"border-danger is-invalid":""}`,onClick:()=>!_&&!g&&N(!h),style:{cursor:_||g?"not-allowed":"pointer",borderRadius:"0.375rem",minHeight:"38px"},children:[i?e.jsx("div",{className:"d-flex align-items-center",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-weight-medium text-gray-800",children:i.goal_name}),e.jsx("small",{className:`${i.is_family_goal?"text-info":"text-muted"}`,children:i.is_family_goal?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-users mr-1"}),"Family Goal"]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-user mr-1"}),"Personal Goal"]})})]})}):e.jsx("span",{className:`${y&&c?"text-danger":"text-muted"}`,children:g?"Loading goals...":c?"Select Goal":"Select Goal (Optional)"}),e.jsxs("div",{className:"d-flex align-items-center",children:[i&&e.jsx("button",{type:"button",className:"btn btn-sm text-danger mr-2",onClick:a=>{a.stopPropagation(),z()},title:"Clear selection",style:{border:"none",background:"none",padding:"2px 6px"},children:e.jsx("i",{className:"fas fa-times"})}),e.jsx("i",{className:`fas fa-chevron-${h?"up":"down"} text-gray-400`})]})]}),h&&e.jsxs("div",{className:"position-absolute w-100 bg-white border shadow-lg",style:{zIndex:1050,maxHeight:"300px",overflowY:"auto",top:"100%",borderRadius:"0.375rem",borderColor:"#dee2e6"},children:[e.jsx("div",{className:"p-3 border-bottom",children:e.jsx("input",{type:"text",className:"px-3 py-2 w-100 border",placeholder:"Search goals...",value:v,onChange:a=>w(a.target.value),autoFocus:!0,style:{borderRadius:"0.25rem",fontSize:"14px",borderColor:"#dee2e6",outline:"none"}})}),e.jsx("div",{className:"py-1",children:E.length===0?e.jsx("div",{className:"px-3 py-2 text-muted text-center",children:v?"No goals found":"No goals available"}):E.map(a=>e.jsxs("div",{className:`px-3 py-2 d-flex align-items-center ${i?.id===a.id?"bg-primary text-white":""}`,onClick:()=>T(a),style:{cursor:"pointer",transition:"background-color 0.15s ease-in-out"},onMouseEnter:t=>{i?.id!==a.id&&(t.currentTarget.style.backgroundColor="#f8f9fc")},onMouseLeave:t=>{i?.id!==a.id&&(t.currentTarget.style.backgroundColor="")},children:[e.jsxs("div",{className:"flex-grow-1",children:[e.jsx("div",{className:"font-weight-medium",children:a.goal_name}),e.jsx("small",{className:`${a.is_family_goal?"text-info":"text-muted"}`,children:a.is_family_goal?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-users mr-1"}),"Family Goal"]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-user mr-1"}),"Personal Goal"]})})]}),i?.id===a.id&&e.jsx("i",{className:"fas fa-check text-white"})]},a.id))})]})]}),e.jsx("small",{className:"form-text text-muted",children:m&&c?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-info-circle mr-1"}),"Goal selection is required for contribution transactions",o&&r.isFamilyMember&&e.jsxs(e.Fragment,{children:[" â€¢ ",e.jsx("span",{className:"text-info",children:"Family goal access checked"})]})]}):e.jsxs(e.Fragment,{children:["Is this transaction related to one of your financial goals?",o&&k.some(a=>a.is_family_goal)&&e.jsxs(e.Fragment,{children:[" ",e.jsxs("span",{className:"text-info",children:[e.jsx("i",{className:"fas fa-shield-alt mr-1"}),"Family goals require proper permissions"]})]})]})}),o&&r.isFamilyMember&&e.jsx("div",{className:"mt-2",children:e.jsxs("small",{className:"text-muted d-flex align-items-center",children:[e.jsx("i",{className:"fas fa-info-circle text-info mr-1"}),"Role: ",e.jsx("span",{className:"font-weight-bold text-capitalize ml-1",children:r.familyRole}),!r.hasContributionAccess&&m&&e.jsxs("span",{className:"ml-2 text-warning",children:[e.jsx("i",{className:"fas fa-exclamation-triangle mr-1"}),"Limited contribution access"]})]})}),y&&c&&!i&&e.jsxs("div",{className:"invalid-feedback d-block",children:[e.jsx("i",{className:"fas fa-exclamation-triangle mr-1"}),"Please select a goal for your contribution"]}),e.jsx(Q,{isOpen:f.isOpen,onClose:()=>C({isOpen:!1,title:"",message:""}),errorTitle:f.title,errorMessage:f.message,suggestedActions:f.suggestedActions,userRole:f.userRole})]})};export{ee as G};
