import{s as a}from"./index-BbApZ7g3.js";class y{classifyError(r){const e=r?.message||"Unknown error",i=r?.code;return e.includes("not registered")||e.includes("create an account")||e.includes("User with this email address is not registered")?{type:"USER_NOT_REGISTERED",message:e,userMessage:"This email address is not registered with BudgetMe. Please ask them to create an account first.",canRetry:!1,suggestedAction:"Ask the user to register at BudgetMe before sending an invitation."}:e.includes("already invited")||e.includes("already been sent")?{type:"USER_ALREADY_INVITED",message:e,userMessage:"An invitation has already been sent to this email address.",canRetry:!1,suggestedAction:"Check your sent invitations or wait for the user to respond."}:e.includes("already part of a family")||e.includes("already a member")?{type:"USER_ALREADY_MEMBER",message:e,userMessage:"This user is already a member of another family. Users can only belong to one family at a time.",canRetry:!1,suggestedAction:"The user must leave their current family before joining yours."}:e.includes("permission")||e.includes("not authorized")||e.includes("admin")||i==="42501"?{type:"PERMISSION_DENIED",message:e,userMessage:"You do not have permission to invite members to this family.",canRetry:!1,suggestedAction:"Contact a family admin to send invitations."}:e.includes("function not found")||i==="42883"?{type:"DATABASE_ERROR",message:e,userMessage:"System configuration issue. Please contact support.",canRetry:!0,suggestedAction:"Try again in a few minutes or contact support if the issue persists."}:e.includes("verification failed")||e.includes("Unable to verify")?{type:"VERIFICATION_FAILED",message:e,userMessage:"There was an issue verifying the user. Please check the email address and try again.",canRetry:!0,suggestedAction:"Double-check the email address and try again in a moment."}:e.includes("invalid")||e.includes("format")||e.includes("validation")?{type:"VALIDATION_ERROR",message:e,userMessage:"Please check your input and try again.",canRetry:!0,suggestedAction:"Verify the email format and all required fields."}:e.includes("Internal Server Error")||e.includes("500")||e.includes("timeout")||e.includes("network")?{type:"SYSTEM_ERROR",message:e,userMessage:"A temporary system issue occurred. Please try again in a moment.",canRetry:!0,suggestedAction:"Wait a few minutes and try again. Contact support if the issue persists."}:{type:"SYSTEM_ERROR",message:e,userMessage:`An unexpected error occurred: ${e}`,canRetry:!0,suggestedAction:"Try again or contact support if the issue persists."}}generateToken(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}async sendInvitation(r,e){try{return console.log("Starting enhanced invitation process:",{familyId:r.family_id,inviteeEmail:r.email,inviterId:e,role:r.role}),await this.sendInvitationAttempt(r,e)}catch(i){console.error("Error in sendInvitation:",i);const s=this.classifyError(i);console.log("Error classified as:",s);const o=new Error(s.userMessage);throw o.classification=s,o.originalError=i,o}}async sendInvitationAttempt(r,e){try{const{data:i,error:s}=await a.from("family_members").select("role, status").eq("family_id",r.family_id).eq("user_id",e).eq("status","active").single();let o=!1;if(!s&&i&&i.role==="admin")o=!0;else{const{data:t,error:m}=await a.from("families").select("created_by").eq("id",r.family_id).single();!m&&t&&t.created_by===e&&(o=!0)}if(!o)throw new Error("Only family admins and owners can send invitations");console.log("Starting enhanced user verification for email:",r.email);let n=null,c="unknown";try{console.log("Step 1: Attempting RPC verification...");const{data:t,error:m}=await a.rpc("check_user_exists_by_email",{user_email:r.email.trim().toLowerCase()});if(console.log("RPC user check response:",{userCheckResult:t,rpcError:m,hasData:!!t,isArray:Array.isArray(t),length:t?.length}),m)console.warn("RPC user check failed, will try fallback:",{error:m,message:m.message,code:m.code}),m.code==="42883"?console.log("RPC function not found, using fallback verification"):m.code==="42501"?console.log("RPC permission error, using fallback verification"):console.log("RPC error, using fallback verification:",m.message);else if(t&&Array.isArray(t)&&t.length>0){const g=t[0];console.log("Parsed RPC user result:",g),g&&g.user_exists&&g.user_id&&g.email?(n={id:g.user_id,email:g.email,full_name:g.full_name,email_confirmed:g.email_confirmed},c="rpc_success",console.log("User verified via RPC:",n)):console.log("RPC returned user_exists=false, trying fallback verification")}else console.log("RPC returned invalid format, trying fallback verification")}catch(t){console.warn("RPC verification threw exception, trying fallback:",t)}if(!n){console.log("Step 2: Attempting fallback direct query verification...");try{const{data:t,error:m}=await a.from("profiles").select("id, email, full_name, email_verified").ilike("email",r.email.trim()).single();!m&&t?(n={id:t.id,email:t.email,full_name:t.full_name,email_confirmed:t.email_verified},c="fallback_profiles",console.log("User verified via profiles fallback:",n)):(console.log("Profile lookup failed, trying auth.users (this requires admin access):",m?.message),console.log("Fallback verification could not access auth.users directly due to RLS policies"))}catch(t){console.warn("Fallback verification failed:",t)}}if(!n)throw console.error("All verification methods failed for email:",r.email),console.log("Verification summary:",{email:r.email,normalizedEmail:r.email.trim().toLowerCase(),rpcAttempted:!0,fallbackAttempted:!0,verificationMethod:"none"}),new Error("User with this email address is not registered. Please ask them to create an account first.");if(!n.id||!n.email)throw console.error("User data incomplete after verification:",n),new Error("User data incomplete. Please contact support.");console.log("User verification complete:",{userId:n.id,email:n.email,verificationMethod:c,emailConfirmed:n.email_confirmed}),console.log("Found user for invitation:",{userId:n.id,email:n.email});let l;try{if(l=await a.from("family_members").select("family_id, status").eq("user_id",n.id).in("status",["active","pending"]),console.log("Membership check result:",l),l.error)console.warn("Membership check error (continuing anyway):",l.error);else if(l.data&&l.data.length>0)throw console.log("User already has family membership:",l.data[0]),new Error("This user is already part of a family")}catch(t){if(t.message==="This user is already part of a family")throw t;console.warn("Membership check failed, but continuing with invitation:",t)}let d;try{if(d=await a.from("family_invitations").select("id, status").eq("family_id",r.family_id).ilike("email",r.email).eq("status","pending"),console.log("Invitation check result:",d),d.error)console.warn("Invitation check error (continuing anyway):",d.error);else if(d.data&&d.data.length>0)throw console.log("Found existing pending invitation:",d.data[0]),new Error("An invitation has already been sent to this email")}catch(t){if(t.message==="An invitation has already been sent to this email")throw t;console.warn("Invitation check failed, but continuing:",t)}console.log("No existing invitation found, proceeding to create new invitation");const{data:u,error:f}=await a.from("family_invitations").insert({family_id:r.family_id,invited_by:e,email:r.email,role:r.role,message:r.message||"",invitation_token:this.generateToken(),status:"pending",expires_at:new Date(Date.now()+7*24*60*60*1e3).toISOString()}).select().single();if(f)throw console.error("Failed to create invitation:",f),new Error(`Failed to create invitation: ${f.message}`);return console.log("Invitation created successfully:",{invitationId:u.id,email:u.email,familyId:u.family_id}),u}catch(i){throw console.error("Error in sendInvitationAttempt:",i),i}}async acceptInvitation(r,e){try{const{data:i,error:s}=await a.from("family_invitations").select("*").eq("id",r).single();if(s||!i)throw new Error("Invitation not found");if(i.status!=="pending")throw new Error("This invitation is no longer valid");if(new Date(i.expires_at)<new Date)throw new Error("This invitation has expired");const{data:o,error:n}=await a.from("profiles").select("email").eq("id",e).single();if(n||!o)throw new Error("User not found");if(o.email!==i.email)throw new Error("Email mismatch - this invitation is not for your account");const{data:c,error:l}=await a.from("family_members").select("family_id").eq("user_id",e).eq("status","active").limit(1);if(!l&&c&&c.length>0)throw new Error("You are already a member of a family");const{error:d}=await a.rpc("accept_family_invitation",{p_invitation_token:i.invitation_token,p_user_id:e});if(d)throw new Error(`Failed to accept invitation: ${d.message}`)}catch(i){throw console.error("Error in acceptInvitation:",i),i}}async declineInvitation(r,e){try{const{data:i,error:s}=await a.from("family_invitations").select("email, status").eq("id",r).single();if(s||!i)throw new Error("Invitation not found");const{data:o,error:n}=await a.from("profiles").select("email").eq("id",e).single();if(n||!o||o.email!==i.email)throw new Error("This invitation is not for your account");if(i.status!=="pending")throw new Error("This invitation is no longer valid");const{error:c}=await a.from("family_invitations").update({status:"declined"}).eq("id",r);if(c)throw new Error(`Failed to decline invitation: ${c.message}`)}catch(i){throw console.error("Error in declineInvitation:",i),i}}async cancelInvitation(r,e){try{const{data:i,error:s}=await a.from("family_invitations").select("invited_by, family_id, status").eq("id",r).single();if(s||!i)throw new Error("Invitation not found");if(i.status!=="pending")throw new Error("This invitation cannot be cancelled");let o=i.invited_by===e;if(!o){const{data:c,error:l}=await a.from("family_members").select("role").eq("family_id",i.family_id).eq("user_id",e).eq("status","active").single();o=!l&&c?.role==="admin"}if(!o)throw new Error("You do not have permission to cancel this invitation");const{error:n}=await a.from("family_invitations").update({status:"cancelled"}).eq("id",r);if(n)throw new Error(`Failed to cancel invitation: ${n.message}`)}catch(i){throw console.error("Error in cancelInvitation:",i),i}}async getPendingInvitations(r){try{const{data:e,error:i}=await a.from("profiles").select("email").eq("id",r).single();if(i||!e)return[];const{data:s,error:o}=await a.from("family_invitations").select(`
          *,
          families (
            family_name
          )
        `).eq("email",e.email).eq("status","pending").gt("expires_at",new Date().toISOString());if(o)throw new Error(`Failed to get invitations: ${o.message}`);if(!s||s.length===0)return[];const n=s.map(u=>u.invited_by),{data:c,error:l}=await a.from("profiles").select("id, email, full_name").in("id",n);return l&&console.warn("Error fetching inviter details:",l),s.map(u=>{const f=c?.find(t=>t.id===u.invited_by);return{...u,family_name:u.families?.family_name,inviter_name:f?.full_name||f?.email?.split("@")[0]||"Unknown",inviter_email:f?.email}})}catch(e){throw console.error("Error in getPendingInvitations:",e),e}}async getSentInvitations(r,e){try{const{data:i,error:s}=await a.from("family_members").select("role").eq("family_id",r).eq("user_id",e).eq("status","active").single();if(s||!i)throw new Error("You are not a member of this family");const{data:o,error:n}=await a.from("family_invitations").select("*").eq("family_id",r).order("created_at",{ascending:!1});if(n)throw new Error(`Failed to get invitations: ${n.message}`);if(!o||o.length===0)return[];const c=Array.from(new Set(o.map(f=>f.invited_by))),{data:l,error:d}=await a.from("profiles").select("id, email, full_name").in("id",c);return d&&console.warn("Error fetching inviter details:",d),o.map(f=>{const t=l?.find(m=>m.id===f.invited_by);return{...f,inviter_name:t?.full_name||t?.email?.split("@")[0]||"Unknown",inviter_email:t?.email}})}catch(i){throw console.error("Error in getSentInvitations:",i),i}}async getInvitationByToken(r){try{const{data:e,error:i}=await a.from("family_invitations").select(`
          *,
          families (
            family_name
          )
        `).eq("invitation_token",r).single();if(i||!e)return null;const{data:s}=await a.from("profiles").select("email, full_name").eq("id",e.invited_by).single();return{...e,family_name:e.families?.family_name,inviter_name:s?.full_name||s?.email?.split("@")[0]||"Unknown",inviter_email:s?.email}}catch(e){return console.error("Error in getInvitationByToken:",e),null}}async cleanupExpiredInvitations(){try{const{data:r,error:e}=await a.from("family_invitations").update({status:"expired"}).eq("status","pending").lt("expires_at",new Date().toISOString()).select();if(e)throw new Error(`Failed to cleanup expired invitations: ${e.message}`);return r?.length||0}catch(r){throw console.error("Error in cleanupExpiredInvitations:",r),r}}}const w=new y;export{w as i};
