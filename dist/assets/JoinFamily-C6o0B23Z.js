import{j as e}from"./ui-vendor-Cn1Vfl4w.js";import{r as w}from"./react-vendor-D4A9EtXC.js";import{s as o,u as J,b as S,l as F}from"./index-BbApZ7g3.js";import"./chart-vendor-B0c7K_uV.js";class T{async createJoinRequest(a,t){try{const{data:s,error:i}=await o.from("families").select("id, family_name, is_public").eq("id",a.family_id).single();if(i||!s)throw new Error("Family not found");if(!s.is_public)throw new Error("This family is not accepting join requests");const{data:n,error:l}=await o.from("family_members").select("family_id, status").eq("user_id",t).in("status",["active","pending"]).limit(1);if(!l&&n&&n.length>0)throw new Error("You are already a member of a family");const{data:c,error:u}=await o.from("family_join_requests").select("id, status").eq("family_id",a.family_id).eq("user_id",t);if(u&&u.code!=="PGRST116"&&console.warn("Error checking existing requests:",u),c&&c.length>0){const _=c.find(d=>d.status==="pending"),b=c.find(d=>d.status==="approved");if(_)throw new Error("You already have a pending request to join this family");if(b)throw new Error("You are already approved to join this family");const h=c.filter(d=>d.status==="denied"||d.status==="cancelled").map(d=>d.id);h.length>0&&await o.from("family_join_requests").delete().in("id",h)}const{data:p,error:f}=await o.from("family_join_requests").insert({family_id:a.family_id,user_id:t,status:"pending",message:a.message||""}).select().single();if(f)throw new Error(`Failed to create join request: ${f.message}`);return p}catch(s){throw console.error("Error in createJoinRequest:",s),s}}async approveJoinRequest(a,t,s="viewer"){try{const{data:i,error:n}=await o.from("family_join_requests").select("*").eq("id",a).single();if(n||!i)throw new Error("Join request not found");if(i.status!=="pending")throw new Error("This request has already been processed");const{data:l,error:c}=await o.from("family_members").select("role, status").eq("family_id",i.family_id).eq("user_id",t).eq("status","active").single();if(c||!l||l.role!=="admin")throw new Error("Only family admins can approve join requests");const{data:u,error:p}=await o.from("family_members").select("family_id").eq("user_id",i.user_id).eq("status","active").limit(1);if(!p&&u&&u.length>0)throw await o.from("family_join_requests").update({status:"denied",updated_at:new Date().toISOString()}).eq("id",a),new Error("User is already a member of another family");const{error:f}=await o.rpc("approve_join_request",{p_request_id:a,p_role:s});if(f)throw new Error(`Failed to approve join request: ${f.message}`)}catch(i){throw console.error("Error in approveJoinRequest:",i),i}}async denyJoinRequest(a,t){try{const{data:s,error:i}=await o.from("family_join_requests").select("family_id, user_id, status").eq("id",a).single();if(i||!s)throw new Error("Join request not found");if(s.status!=="pending")throw new Error("This request has already been processed");const{data:n,error:l}=await o.from("family_members").select("role").eq("family_id",s.family_id).eq("user_id",t).eq("status","active").single();if(l||!n||n.role!=="admin")throw new Error("Only family admins can deny join requests");const{error:c}=await o.from("family_join_requests").update({status:"denied",updated_at:new Date().toISOString()}).eq("id",a);if(c)throw new Error(`Failed to deny join request: ${c.message}`)}catch(s){throw console.error("Error in denyJoinRequest:",s),s}}async cancelJoinRequest(a,t){try{const{data:s,error:i}=await o.from("family_join_requests").select("user_id, status").eq("id",a).single();if(i||!s)throw new Error("Join request not found");if(s.user_id!==t)throw new Error("You can only cancel your own join requests");if(s.status!=="pending")throw new Error("This request cannot be cancelled");const{error:n}=await o.from("family_join_requests").update({status:"cancelled",updated_at:new Date().toISOString()}).eq("id",a);if(n)throw new Error(`Failed to cancel join request: ${n.message}`)}catch(s){throw console.error("Error in cancelJoinRequest:",s),s}}async getFamilyJoinRequests(a,t){try{const{data:s,error:i}=await o.from("family_members").select("role").eq("family_id",a).eq("user_id",t).eq("status","active").single();if(i||!s||s.role!=="admin")throw new Error("Only family admins can view join requests");const{data:n,error:l}=await o.from("family_join_requests").select("*").eq("family_id",a).order("created_at",{ascending:!1});if(l)throw new Error(`Failed to get join requests: ${l.message}`);if(!n||n.length===0)return[];const c=n.map(b=>b.user_id),{data:u,error:p}=await o.from("profiles").select("id, email, full_name, avatar_url").in("id",c);p&&console.warn("Error fetching user details:",p);const{data:f}=await o.from("families").select("family_name").eq("id",a).single();return n.map(b=>{const h=u?.find(d=>d.id===b.user_id);return{...b,family_name:f?.family_name,user_name:h?.full_name||h?.email?.split("@")[0]||"Unknown",user_email:h?.email,user_avatar:h?.avatar_url}})}catch(s){throw console.error("Error in getFamilyJoinRequests:",s),s}}async getUserJoinRequests(a){try{const{data:t,error:s}=await o.from("family_join_requests").select(`
          *,
          families (
            family_name
          )
        `).eq("user_id",a).order("created_at",{ascending:!1});if(s)throw new Error(`Failed to get join requests: ${s.message}`);return!t||t.length===0?[]:t.map(n=>({...n,family_name:n.families?.family_name}))}catch(t){throw console.error("Error in getUserJoinRequests:",t),t}}async getPendingRequestsCount(a){try{const{count:t,error:s}=await o.from("family_join_requests").select("*",{count:"exact",head:!0}).eq("family_id",a).eq("status","pending");return s?(console.warn("Error getting pending requests count:",s),0):t||0}catch(t){return console.error("Error in getPendingRequestsCount:",t),0}}async cleanupOldRequests(a=30){try{const t=new Date;t.setDate(t.getDate()-a);const{data:s,error:i}=await o.from("family_join_requests").delete().in("status",["denied","cancelled"]).lt("created_at",t.toISOString()).select();if(i)throw new Error(`Failed to cleanup old requests: ${i.message}`);return s?.length||0}catch(t){throw console.error("Error in cleanupOldRequests:",t),t}}}const R=new T,A=({onJoinSuccess:N})=>{const{user:a}=J(),{showSuccessToast:t,showErrorToast:s}=S(),[i,n]=w.useState([]),[l,c]=w.useState(!1),[u,p]=w.useState(!1),[f,_]=w.useState(null),[b,h]=w.useState(!1),[d,k]=w.useState(0),q=w.useCallback(async()=>{if(a){c(!0),h(!1);try{let r=!1;try{if(r=(await F.checkFamilyMembership(a.id)).is_member,r){n([]),s("You are already a member of a family. You can only be a member of one family at a time.");return}}catch(m){console.warn("Error checking family membership, proceeding with family lookup:",m)}const j=await F.getPublicFamilies(a.id);if(j.length===0){n([]);return}let x=new Set;try{const m=await R.getUserJoinRequests(a.id);x=new Set(m.filter(y=>y.status==="pending").map(y=>y.family_id))}catch(m){console.warn("Error fetching user join requests:",m)}const g=j.map(m=>({...m,already_requested:x.has(m.id),request_status:x.has(m.id)?"pending":null}));n(g)}catch(r){console.error("Error in fetchAvailableFamilies:",r);const j=r instanceof Error?r.message:"Unknown error";h(!0),j.includes("406")||j.includes("Not Acceptable")?s("There was an issue loading family data. Please try refreshing or try again later."):j.includes("timeout")||j.includes("network")?s("Network error. Please check your connection and try again."):s(`Failed to load families: ${j}`),n([])}finally{c(!1)}}},[a,s]),v=async()=>{d<3?(k(r=>r+1),h(!1),await q()):s("Unable to load families after multiple attempts. Please refresh the page.")},E=async r=>{if(!a){s("You must be logged in to join a family");return}if(i.find(x=>x.id===r)?.already_requested){s("You have already requested to join this family.");return}_(r),p(!0);try{await R.createJoinRequest({family_id:r,message:"I would like to join your family."},a.id);const x=i.map(g=>g.id===r?{...g,already_requested:!0,request_status:"pending"}:g);n(x),t("Join request sent successfully. Waiting for approval."),N&&N()}catch(x){console.error("Error in handleJoinRequest:",x);const g=x instanceof Error?x.message:"Unknown error";if(g.includes("duplicate key value violates unique constraint")){s("You have already requested to join this family.");const m=i.map(y=>y.id===r?{...y,already_requested:!0,request_status:"pending"}:y);n(m)}else if(g.includes("already a member"))s("You are already a member of a family. You can only be a member of one family at a time."),q();else if(g.includes("already have a pending request")){s("You already have a pending request to join this family.");const m=i.map(y=>y.id===r?{...y,already_requested:!0,request_status:"pending"}:y);n(m)}else s(`Failed to send join request: ${g}`)}finally{p(!1),_(null)}};return w.useEffect(()=>{q()},[q]),e.jsxs("div",{children:[e.jsxs("div",{className:"block md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h5",{className:"text-sm font-bold text-gray-800",children:"Available Families"}),e.jsx("button",{className:"w-8 h-8 rounded-full bg-indigo-100 hover:bg-indigo-200 text-indigo-600 flex items-center justify-center transition-all active:scale-95",onClick:q,disabled:l,children:e.jsx("i",{className:`fas ${l?"fa-spinner fa-spin":"fa-sync"} text-xs`})})]}),l?e.jsx("div",{className:"py-8 animate__animated animate__fadeIn",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-indigo-500 animate-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-2 h-2 rounded-full bg-indigo-500 animate-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-2 h-2 rounded-full bg-indigo-500 animate-bounce",style:{animationDelay:"300ms"}})]}),e.jsx("p",{className:"mt-3 text-xs text-gray-500 font-medium",children:"Loading families..."})]})}):b?e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-amber-100 flex items-center justify-center mx-auto mb-3",children:e.jsx("i",{className:"fas fa-exclamation-triangle text-amber-500 text-xl"})}),e.jsx("h5",{className:"text-sm font-semibold text-gray-700 mb-1",children:"Failed to Load"}),e.jsx("p",{className:"text-xs text-gray-500 mb-4",children:"There was an issue loading families."}),e.jsx("div",{className:"flex justify-center gap-2",children:e.jsxs("button",{className:"px-4 py-2 bg-indigo-500 text-white text-xs font-medium rounded-lg hover:bg-indigo-600 transition-colors",onClick:v,disabled:l,children:[e.jsx("i",{className:`fas ${l?"fa-spinner fa-spin":"fa-redo"} mr-1`}),"Try Again ",d>0&&`(${d}/3)`]})})]}):i.length>0?e.jsxs("div",{className:"space-y-2",children:[i.map(r=>e.jsxs("div",{className:"bg-white rounded-xl p-3 shadow-sm border border-gray-100",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h6",{className:"text-sm font-bold text-gray-800 truncate",children:r.family_name}),e.jsx("p",{className:"text-[10px] text-gray-500 truncate",children:r.description||"No description"})]}),e.jsxs("span",{className:"bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full text-[9px] font-semibold ml-2 flex-shrink-0",children:[e.jsx("i",{className:"fas fa-users mr-1"}),r.member_count||0]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-[9px] text-gray-400",children:[e.jsx("i",{className:"fas fa-user mr-1"}),r.creator_name||"Unknown"]}),r.already_requested?e.jsxs("span",{className:"px-3 py-1.5 bg-gray-100 text-gray-500 text-[10px] font-medium rounded-lg",children:[e.jsx("i",{className:"fas fa-clock mr-1"}),"Pending"]}):e.jsx("button",{className:"px-3 py-1.5 bg-indigo-500 text-white text-[10px] font-medium rounded-lg hover:bg-indigo-600 transition-colors disabled:opacity-50",onClick:()=>E(r.id),disabled:u&&f===r.id,children:u&&f===r.id?e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-spinner fa-spin mr-1"}),"Joining..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-sign-in-alt mr-1"}),"Join"]})})]})]},r.id)),e.jsx("div",{className:"bg-blue-50 rounded-xl p-3 mt-3",children:e.jsxs("p",{className:"text-[10px] text-blue-600 flex items-start gap-2",children:[e.jsx("i",{className:"fas fa-info-circle mt-0.5"}),e.jsx("span",{children:"Join requests require admin approval. You will join as a member."})]})})]}):e.jsxs("div",{className:"py-8 text-center",children:[e.jsx("div",{className:"w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-3",children:e.jsx("i",{className:"fas fa-users text-gray-400 text-xl"})}),e.jsx("h5",{className:"text-sm font-semibold text-gray-600 mb-1",children:"No Families Available"}),e.jsx("p",{className:"text-xs text-gray-400",children:"No public families to join at the moment."})]})]}),e.jsxs("div",{className:"hidden md:block",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[e.jsx("h5",{className:"text-gray-700 font-weight-bold mb-0",children:"Available Families"}),e.jsxs("button",{className:"btn btn-sm btn-outline-primary",onClick:q,disabled:l,children:[e.jsx("i",{className:`fas ${l?"fa-spinner fa-spin":"fa-sync"} mr-1`}),"Refresh"]})]}),l?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"sr-only",children:"Loading..."})}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Loading available families..."})]}):b?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("i",{className:"fas fa-exclamation-triangle fa-3x text-warning mb-3"}),e.jsx("h5",{className:"text-gray-600 font-weight-light mb-2",children:"Failed to Load Families"}),e.jsx("p",{className:"text-gray-500 mb-4 small",children:"There was an issue loading available families. This might be a temporary network issue."}),e.jsxs("div",{className:"d-flex justify-content-center gap-2",children:[e.jsxs("button",{className:"btn btn-primary btn-sm",onClick:v,disabled:l,children:[e.jsx("i",{className:`fas ${l?"fa-spinner fa-spin":"fa-retry"} mr-1`}),"Try Again ",d>0&&`(${d}/3)`]}),e.jsxs("button",{className:"btn btn-outline-secondary btn-sm",onClick:()=>window.location.reload(),children:[e.jsx("i",{className:"fas fa-refresh mr-1"}),"Refresh Page"]})]})]}):i.length>0?e.jsxs("div",{className:"card shadow",children:[e.jsx("div",{className:"card-body p-0",children:e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table mb-0",children:[e.jsx("thead",{className:"bg-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Family Name"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Created By"}),e.jsx("th",{children:"Members"}),e.jsx("th",{children:"Created On"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:i.map(r=>e.jsxs("tr",{children:[e.jsx("td",{className:"font-weight-bold",children:r.family_name}),e.jsx("td",{children:r.description||"No description"}),e.jsx("td",{children:r.creator_name||"Unknown"}),e.jsx("td",{children:e.jsxs("span",{className:"badge badge-info",children:[e.jsx("i",{className:"fas fa-users mr-1"})," ",r.member_count||0," members"]})}),e.jsx("td",{children:new Date(r.created_at).toLocaleDateString()}),e.jsx("td",{children:r.already_requested?e.jsxs("button",{className:"btn btn-sm btn-secondary",disabled:!0,children:[e.jsx("i",{className:"fas fa-clock mr-1"})," Request Pending"]}):e.jsx("button",{className:"btn btn-sm btn-primary",onClick:()=>E(r.id),disabled:u&&f===r.id,children:u&&f===r.id?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm mr-1",role:"status","aria-hidden":"true"}),"Joining..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"fas fa-sign-in-alt mr-1"})," Request to Join as Member"]})})})]},r.id))})]})})}),e.jsx("div",{className:"card-footer bg-light",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("i",{className:"fas fa-info-circle mr-1"}),"Once you request to join, the family admin will need to approve your request. You will join as a member."]})})]}):e.jsxs("div",{className:"text-center py-5",children:[e.jsx("i",{className:"fas fa-users fa-3x text-gray-300 mb-3"}),e.jsx("h5",{className:"text-gray-500 font-weight-light mb-2",children:"No Families Available to Join"}),e.jsx("p",{className:"text-gray-500 mb-4 small",children:"There are no public families available for you to join at the moment."})]})]})]})};export{A as default};
