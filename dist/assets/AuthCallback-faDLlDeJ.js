const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BbApZ7g3.js","assets/ui-vendor-Cn1Vfl4w.js","assets/react-vendor-D4A9EtXC.js","assets/chart-vendor-B0c7K_uV.js","assets/index-hrYhFl6X.css"])))=>i.map(i=>d[i]);
import{s as d,_ as p}from"./index-BbApZ7g3.js";import{j as t}from"./ui-vendor-Cn1Vfl4w.js";import{u as P,r as v}from"./react-vendor-D4A9EtXC.js";import"./chart-vendor-B0c7K_uV.js";const y=async()=>{const e={sessionExists:!1,tokenValid:!1,pkceStateExists:!1,storageKeys:[],authErrors:[]};try{const{data:s,error:u}=await d.auth.getSession();if(u&&e.authErrors.push(`Session Error: ${u.message}`),s?.session?.user&&(e.sessionExists=!0,e.userId=s.session.user.id,e.userEmail=s.session.user.email,e.tokenValid=!0),typeof window<"u"){const r=Object.keys(localStorage);e.storageKeys=r.filter(a=>a.includes("auth")||a.includes("supabase")||a.includes("sb-")||a.includes("pkce")||a.includes("budgetme")),e.pkceStateExists=r.some(a=>a.includes("pkce")||a.includes("code_verifier"))}}catch(s){e.authErrors.push(`Debug Error: ${s.message}`)}return e},I=()=>{const e=new URL(window.location.href),s=new URLSearchParams(e.search),u=new URLSearchParams(e.hash.substring(1)),r={},a=Array.from(s.entries()),w=Array.from(u.entries());[...a,...w].forEach(([h,f])=>{["code","access_token","refresh_token","error","next","token","type"].includes(h)&&(r[h]=f)});const c=Object.keys(r).length>0,E=r.next==="/reset-password"||r.type==="recovery";return{hasAuthParams:c,params:r,isPasswordReset:E}},S=async()=>{console.group("ðŸ” Auth Debug Information");const e=await y(),s=I();console.log("Session Info:",{exists:e.sessionExists,userId:e.userId,email:e.userEmail,tokenValid:e.tokenValid}),console.log("Storage Info:",{pkceState:e.pkceStateExists,keys:e.storageKeys}),console.log("URL Info:",s),e.authErrors.length>0&&console.error("Auth Errors:",e.authErrors),console.groupEnd()},R=e=>t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 128 128",...e,children:[t.jsx("path",{fill:"#fff",d:"M44.59 4.21a63.28 63.28 0 004.33 120.9 67.6 67.6 0 0032.36.35 57.13 57.13 0 0025.9-13.46 57.44 57.44 0 0016-26.26 74.33 74.33 0 001.61-33.58H65.27v24.69h34.47a29.72 29.72 0 01-12.66 19.52 36.16 36.16 0 01-13.93 5.5 41.29 41.29 0 01-15.1 0A37.16 37.16 0 0144 95.74a39.3 39.3 0 01-14.5-19.42 38.31 38.31 0 010-24.63 39.25 39.25 0 019.18-14.91A37.17 37.17 0 0176.13 27a34.28 34.28 0 0113.64 8q5.83-5.8 11.64-11.63c2-2.09 4.18-4.08 6.15-6.22A61.22 61.22 0 0087.2 4.59a64 64 0 00-42.61-.38z"}),t.jsx("path",{fill:"#e33629",d:"M44.59 4.21a64 64 0 0142.61.37 61.22 61.22 0 0120.35 12.62c-2 2.14-4.11 4.14-6.15 6.22Q95.58 29.23 89.77 35a34.28 34.28 0 00-13.64-8 37.17 37.17 0 00-37.46 9.74 39.25 39.25 0 00-9.18 14.91L8.76 35.6A63.53 63.53 0 0144.59 4.21z"}),t.jsx("path",{fill:"#f8bd00",d:"M3.26 51.5a62.93 62.93 0 015.5-15.9l20.73 16.09a38.31 38.31 0 000 24.63q-10.36 8-20.73 16.08a63.33 63.33 0 01-5.5-40.9z"}),t.jsx("path",{fill:"#587dbd",d:"M65.27 52.15h59.52a74.33 74.33 0 01-1.61 33.58 57.44 57.44 0 01-16 26.26c-6.69-5.22-13.41-10.4-20.1-15.62a29.72 29.72 0 0012.66-19.54H65.27c-.01-8.22 0-16.45 0-24.68z"}),t.jsx("path",{fill:"#319f43",d:"M8.75 92.4q10.37-8 20.73-16.08A39.3 39.3 0 0044 95.74a37.16 37.16 0 0014.08 6.08 41.29 41.29 0 0015.1 0 36.16 36.16 0 0013.93-5.5c6.69 5.22 13.41 10.4 20.1 15.62a57.13 57.13 0 01-25.9 13.47 67.6 67.6 0 01-32.36-.35 63 63 0 01-23-11.59A63.73 63.73 0 018.75 92.4z"})]}),L=()=>{const e=P();return v.useEffect(()=>{let s=!0;return(async()=>{try{console.log("Processing auth callback...",window.location.href);const r=new URLSearchParams(window.location.search),a=new URLSearchParams(window.location.hash.substring(1)),c=r.get("next")==="/reset-password";if(!(r.has("code")||r.has("access_token")||r.has("refresh_token")||a.has("access_token")||a.has("refresh_token")||r.has("token"))){console.log("No authentication parameters found in URL"),s&&e("/",{replace:!0});return}const h=r.get("code");if(h){console.log("Processing PKCE code exchange for:",c?"password reset":"OAuth login");let n;try{console.log("Exchanging code for session...");const{data:o,error:i}=await d.auth.exchangeCodeForSession(h);if(n=o,console.log("Exchange result:",{hasData:!!o,hasSession:!!o?.session,hasUser:!!o?.session?.user,hasError:!!i,error:i}),i){if(console.error("Error exchanging code for session:",i),i.message?.includes("code verifier")||i.message?.includes("invalid request")){console.log("PKCE flow issue detected, attempting session recovery"),await S(),await new Promise(l=>setTimeout(l,500));const{data:g}=await d.auth.getSession();if(g?.session?.user){if(console.log("Session recovery successful"),s)if(c)e("/reset-password",{replace:!0});else try{const{isUserAdmin:l}=await p(async()=>{const{isUserAdmin:A}=await import("./index-BbApZ7g3.js").then(_=>_.C);return{isUserAdmin:A}},__vite__mapDeps([0,1,2,3,4]));await l()?e("/admin/dashboard",{replace:!0}):e("/dashboard",{replace:!0})}catch(l){console.error("Error checking admin status:",l),e("/dashboard",{replace:!0})}return}}s&&(c?e("/reset-password?error="+encodeURIComponent("Invalid or expired reset link. Please request a new password reset link from your email."),{replace:!0}):e("/?error="+encodeURIComponent("Authentication failed. Please try again."),{replace:!0}));return}}catch(o){console.error("Exception during code exchange:",o),s&&(c?e("/reset-password?error="+encodeURIComponent("Authentication failed. Please request a new reset link."),{replace:!0}):e("/?error="+encodeURIComponent("Authentication failed. Please try again."),{replace:!0}));return}if(n?.session?.user){console.log("PKCE authentication successful for:",n.session.user.email);const{data:o}=await d.auth.getSession();if(console.log("Session verification after exchange:",{hasSession:!!o?.session,hasUser:!!o?.session?.user,userId:o?.session?.user?.id}),await new Promise(i=>setTimeout(i,800)),s)if(c)console.log("Redirecting to password reset form"),e("/reset-password",{replace:!0});else{console.log("Redirecting to dashboard");try{const{isUserAdmin:i}=await p(async()=>{const{isUserAdmin:l}=await import("./index-BbApZ7g3.js").then(b=>b.C);return{isUserAdmin:l}},__vite__mapDeps([0,1,2,3,4]));await i()?e("/admin/dashboard",{replace:!0}):e("/dashboard",{replace:!0})}catch(i){console.error("Error checking admin status:",i),e("/dashboard",{replace:!0})}}return}else console.warn("No session or user in exchange data:",n)}const f=a.get("access_token")||r.get("access_token"),k=a.get("refresh_token")||r.get("refresh_token");if(f&&k){console.log("Setting session from tokens");const{data:n,error:o}=await d.auth.setSession({access_token:f,refresh_token:k});if(n?.session?.user&&s){c?e("/reset-password",{replace:!0}):e("/dashboard",{replace:!0});return}}await new Promise(n=>setTimeout(n,1e3));const{data:x,error:m}=await d.auth.getSession();if(m){console.error("Error getting session after auth callback:",m.message),s&&(c?e("/reset-password?error="+encodeURIComponent(m.message),{replace:!0}):e("/",{replace:!0}));return}if(x?.session?.user&&s){const n=x.session.user;if(console.log("Auth callback successful:",{userId:n.id,email:n.email,provider:n.app_metadata?.provider,emailVerified:!!n.email_confirmed_at,isPasswordReset:c}),c)console.log("Redirecting to password reset form"),e("/reset-password",{replace:!0});else{console.log("Redirecting to dashboard");try{const{isUserAdmin:o}=await p(async()=>{const{isUserAdmin:g}=await import("./index-BbApZ7g3.js").then(l=>l.C);return{isUserAdmin:g}},__vite__mapDeps([0,1,2,3,4]));await o()?e("/admin/dashboard",{replace:!0}):e("/dashboard",{replace:!0})}catch(o){console.error("Error checking admin status:",o),e("/dashboard",{replace:!0})}}}else console.log("No valid session found after auth callback"),s&&e("/",{replace:!0})}catch(r){console.error("Error handling auth callback:",r),s&&e("/",{replace:!0})}})(),()=>{s=!1}},[e]),t.jsx("div",{className:"auth-callback-container",children:t.jsxs("div",{className:"loading-spinner",children:[t.jsxs("div",{className:"loading-spinner-icon-wrapper",children:[t.jsx("div",{className:"loading-spinner-ring"}),t.jsx("div",{className:"loading-spinner-ring"}),t.jsx(R,{className:"loading-spinner-icon"})]}),t.jsx("p",{children:"Completing authentication..."}),t.jsx("p",{className:"loading-spinner-subtitle",children:"Please wait"})]})})};export{L as default};
